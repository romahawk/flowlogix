<header
  class="sticky top-0 z-50 flex justify-between items-center px-4 sm:px-6 py-2 sm:py-3 bg-slate-900 text-white shadow-lg border-b border-slate-700">
  <!-- Left: Logo + Title + Tour -->
  <div class="flex items-center gap-3">
    <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="Logo"
      class="h-8 sm:h-9 rounded bg-white p-0.5 flex-shrink-0" />
    <span class="text-sm sm:text-lg font-bold tracking-tight text-white">FlowLogix</span>
    <a href="{{ url_for('onboarding.show_onboarding') }}"
      class="hidden sm:flex items-center gap-1 px-2.5 py-1 bg-white/10 hover:bg-white/20 text-slate-300 hover:text-white text-xs font-medium rounded-md border border-white/10 transition-colors duration-150">
      <i data-lucide="book-open" class="w-3.5 h-3.5"></i>
      Tour
    </a>
  </div>

  <!-- Right: Navigation & Controls -->
  <nav class="flex items-center gap-1 sm:gap-1.5">

    <a href="{{ url_for('dashboard.dashboard') }}"
      class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150
      {% if current_path.startswith(url_for('dashboard.dashboard')) %}
        bg-white/15 text-white ring-1 ring-white/25
      {% else %}
        text-slate-300 hover:text-white hover:bg-white/10
      {% endif %}">
      <i data-lucide="layout-dashboard" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Dashboard</span>
    </a>

    <a href="{{ url_for('warehouse.warehouse') }}"
      class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150
      {% if current_path.startswith(url_for('warehouse.warehouse')) %}
        bg-white/15 text-white ring-1 ring-white/25
      {% else %}
        text-slate-300 hover:text-white hover:bg-white/10
      {% endif %}">
      <i data-lucide="package" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Warehouse</span>
    </a>

    <a href="{{ url_for('delivered.delivered') }}"
      class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150
      {% if current_path.startswith(url_for('delivered.delivered')) %}
        bg-white/15 text-white ring-1 ring-white/25
      {% else %}
        text-slate-300 hover:text-white hover:bg-white/10
      {% endif %}">
      <i data-lucide="truck" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Delivered</span>
    </a>

    <!-- Separator -->
    <div class="hidden sm:block w-px h-5 bg-white/20 mx-0.5"></div>

    <!-- Context-sensitive action button -->
    {% if current_path.startswith(url_for('dashboard.dashboard')) %}
    <button
      class="flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-400 text-white text-sm font-semibold rounded-md shadow-sm transition-colors duration-150 toggle-form-btn"
      title="Add a new incoming order">
      <i data-lucide="plus" class="w-4 h-4 flex-shrink-0 btn-icon-open"></i>
      <i data-lucide="x" class="w-4 h-4 flex-shrink-0 btn-icon-close hidden"></i>
      <span class="hidden sm:inline">New Order</span>
    </button>
    {% elif current_path.startswith(url_for('warehouse.warehouse')) %}
    <button onclick="document.getElementById('manual-order-form').classList.toggle('hidden')"
      class="flex items-center gap-1.5 px-3 py-1.5 bg-emerald-500 hover:bg-emerald-400 text-white text-sm font-semibold rounded-md shadow-sm transition-colors duration-150"
      title="Create a new manually stocked order">
      <i data-lucide="plus" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Add Manual</span>
    </button>
    {% elif current_path.startswith(url_for('delivered.delivered')) %}
    <div class="hidden sm:block w-[90px]"></div>
    {% endif %}

    {% if current_user.role == 'admin' %}
    <a href="{{ url_for('admin.user_management') }}"
      class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150
      {% if current_path.startswith(url_for('admin.user_management')) %}
        bg-white/15 text-white ring-1 ring-white/25
      {% else %}
        text-slate-300 hover:text-white hover:bg-white/10
      {% endif %}">
      <i data-lucide="users" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Users</span>
    </a>
    {% endif %}

    <a href="{{ url_for('activity.activity_logs') }}"
      class="flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150
      {% if current_path.startswith(url_for('activity.activity_logs')) %}
        bg-white/15 text-white ring-1 ring-white/25
      {% else %}
        text-slate-300 hover:text-white hover:bg-white/10
      {% endif %}">
      <i data-lucide="scroll-text" class="w-4 h-4 flex-shrink-0"></i>
      <span class="hidden sm:inline">Logs</span>
    </a>

    {% if DEMO_MODE %}
    <!-- Demo controls dropdown -->
    <div class="relative" id="demo-menu-wrapper">
      <button id="demo-menu-btn" type="button"
        class="flex items-center gap-1 px-2.5 py-1.5 rounded-md text-xs font-semibold bg-amber-500/20 hover:bg-amber-500/35 text-amber-300 border border-amber-500/30 transition-colors duration-150"
        title="Demo data controls">
        <i data-lucide="flask-conical" class="w-3.5 h-3.5 flex-shrink-0"></i>
        <span class="hidden sm:inline">Demo</span>
        <i data-lucide="chevron-down" class="w-3 h-3 flex-shrink-0"></i>
      </button>
      <div id="demo-menu-dropdown"
        class="hidden absolute right-0 mt-1 w-44 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-50 py-1">
        <button type="button" onclick="demoAction('seed')"
          class="w-full text-left px-3 py-2 text-xs text-slate-200 hover:bg-slate-700 flex items-center gap-2">
          <i data-lucide="sprout" class="w-3.5 h-3.5 text-green-400"></i> Seed orders
        </button>
        <button type="button" onclick="demoAction('reset')"
          class="w-full text-left px-3 py-2 text-xs text-slate-200 hover:bg-slate-700 flex items-center gap-2">
          <i data-lucide="refresh-cw" class="w-3.5 h-3.5 text-blue-400"></i> Reset demo
        </button>
        <div class="border-t border-slate-600 my-1"></div>
        <button type="button" onclick="demoAction('clear')"
          class="w-full text-left px-3 py-2 text-xs text-red-400 hover:bg-slate-700 flex items-center gap-2">
          <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Clear all orders
        </button>
      </div>
    </div>
    <script>
      (function () {
        const btn = document.getElementById("demo-menu-btn");
        const menu = document.getElementById("demo-menu-dropdown");
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          menu.classList.toggle("hidden");
        });
        document.addEventListener("click", () => menu.classList.add("hidden"));

        window.demoAction = async function (action) {
          menu.classList.add("hidden");
          const labels = {
            seed:  "Load demo orders (clears existing data)",
            reset: "Reset demo data (clears and reloads)",
            clear: "Clear ALL orders"
          };
          if (!confirm(`${labels[action]}?\n\nThis cannot be undone.`)) return;
          try {
            const r = await fetch(`/demo/${action}`, { method: "POST", credentials: "same-origin" });
            const j = await r.json();
            if (!r.ok) { alert(j.error || "Error"); return; }
            const msg = action === "clear"
              ? `Cleared ${j.deleted} orders.`
              : `Done: ${j.count ?? j.seeded} orders loaded.`;
            alert(msg);
            window.location.reload();
          } catch (e) {
            alert("Request failed: " + e.message);
          }
        };
      })();
    </script>
    {% endif %}

    <!-- Separator -->
    <div class="w-px h-5 bg-white/20 mx-0.5"></div>

    <!-- User badge -->
    <span class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-md bg-white/10 text-slate-200 text-xs font-medium">
      <i data-lucide="circle-user" class="w-4 h-4 text-slate-300 flex-shrink-0"></i>
      <span class="hidden sm:inline">{{ current_user.username }}</span>
      <span class="hidden md:inline text-slate-400">({{ current_user.role }})</span>
    </span>

    <!-- Logout -->
    <a href="{{ url_for('auth.logout') }}" title="Logout"
      class="flex items-center justify-center w-8 h-8 rounded-md text-slate-400 hover:text-red-400 hover:bg-white/10 transition-colors duration-150">
      <i data-lucide="log-out" class="w-4 h-4"></i>
    </a>

    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle"
      class="relative inline-flex items-center h-6 w-11 rounded-full transition-colors duration-300 focus:outline-none flex-shrink-0"
      aria-label="Toggle dark mode">
      <span id="dark-mode-track"
        class="absolute inset-0 rounded-full bg-slate-600 dark:bg-blue-600 transition-colors duration-300"></span>
      <span id="dark-mode-thumb"
        class="absolute left-0.5 top-0.5 h-5 w-5 rounded-full bg-white transform transition-transform duration-300 shadow-md dark:translate-x-5"></span>
    </button>
  </nav>

  <!-- Onboarding Tour Modal -->
  <div id="tourModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-lg w-full shadow-lg relative">
      <button id="closeTourBtn"
        class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 dark:hover:text-white text-xl">&times;</button>
      <h2 class="text-2xl font-bold mb-4">ðŸ‘‹ Welcome to FlowLogix!</h2>
      <div id="tourStepContent" class="text-sm text-gray-700 dark:text-gray-300 space-y-2"></div>
      <div class="mt-6 flex justify-between">
        <button id="prevStepBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded text-sm"
          disabled>Previous</button>
        <button id="nextStepBtn" class="px-4 py-2 bg-blue-600 text-white rounded text-sm">Next</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const steps = [
        {
          title: "Dashboard Overview",
          text: "See all active orders in one place. Use filters and timeline to track delivery progress."
        },
        {
          title: "Warehouse",
          text: "Monitor goods that have arrived but not yet delivered. You can edit quantities or add notes."
        },
        {
          title: "Delivered",
          text: "Track completed deliveries, view PODs (proof of delivery), and manage history."
        },
        {
          title: "Stockreport",
          text: "Break down incoming, stocked, and delivered goods with quantities, batches, and sender details."
        },
        {
          title: "Dark Mode",
          text: "Toggle between light/dark themes from the navbar. Your preference is saved automatically!"
        }
      ];

      const modal = document.getElementById("tourModal");
      const content = document.getElementById("tourStepContent");
      const prevBtn = document.getElementById("prevStepBtn");
      const nextBtn = document.getElementById("nextStepBtn");
      const closeBtn = document.getElementById("closeTourBtn");

      let currentStep = 0;

      function showStep(index) {
        const step = steps[index];
        content.innerHTML = `
          <h3 class="text-lg font-semibold">${step.title}</h3>
          <p>${step.text}</p>
        `;
        prevBtn.disabled = index === 0;
        nextBtn.textContent = index === steps.length - 1 ? "Finish" : "Next";
      }

      function startTour() {
        modal.classList.remove("hidden");
        showStep(currentStep);
      }

      function endTour() {
        modal.classList.add("hidden");
        localStorage.setItem("tourCompleted", "true");
      }

      prevBtn.addEventListener("click", () => {
        if (currentStep > 0) {
          currentStep--;
          showStep(currentStep);
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentStep < steps.length - 1) {
          currentStep++;
          showStep(currentStep);
        } else {
          endTour();
        }
      });

      closeBtn.addEventListener("click", endTour);

      if (!localStorage.getItem("tourCompleted")) {
        startTour();
      }
    });
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script>lucide.createIcons();</script>

  <!-- Dark mode -->
  <script>
      const toggle = document.getElementById('dark-mode-toggle');

      if (localStorage.getItem('dark-mode') === 'enabled') {
        document.documentElement.classList.add('dark');
      }

      toggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('dark-mode',
          document.documentElement.classList.contains('dark') ? 'enabled' : 'disabled'
        );
      });
  </script>
</header>
